services:
  # Rancher Server
  rancher-server:
    image: rancher/rancher:latest
    container_name: rancher-server
    hostname: rancher-server
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${ROOT_DATA_DIR}/rancher-data:/var/lib/rancher
      - ${ROOT_DATA_DIR}/rancher-audit:/var/log/auditlog
    environment:
      - CATTLE_BOOTSTRAP_PASSWORD=${CATTLE_BOOTSTRAP_PASSWORD}
    networks:
      - k8s-network
    privileged: true

  # K8s Control Plane (Master Node)
  k8s-master:
    image: rancher/k3s:latest
    container_name: k8s-master
    hostname: k8s-master
    restart: unless-stopped
    command: server --kubelet-arg="feature-gates=KubeletInUserNamespace=true"
    tmpfs:
      - /run
      - /var/run
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    privileged: true
    ports:
      - "6443:6443"
    environment:
      - K3S_TOKEN=k8s-cluster-secret
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
      - K3S_KUBECONFIG_MODE=666
      - K3S_NODE_NAME=k8s-master
    volumes:
      - ${ROOT_DATA_DIR}/k8s-master:/var/lib/rancher/k3s:shared
      - ${ROOT_DATA_DIR}/k8s-config:/output
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - k8s-network
    mem_limit: 2g
    depends_on:
      - rancher-server

  # Worker Node 1
  k8s-worker-1:
    image: rancher/k3s:latest
    container_name: k8s-worker-1
    hostname: k8s-worker-1
    restart: unless-stopped
    command: agent --kubelet-arg="feature-gates=KubeletInUserNamespace=true" --with-node-id
    tmpfs:
      - /run
      - /var/run
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    privileged: true
    environment:
      - K3S_URL=https://k8s-master:6443
      - K3S_TOKEN=k8s-cluster-secret
      - K3S_NODE_NAME=k8s-worker-1
    volumes:
      - ${ROOT_DATA_DIR}/k8s-worker-1:/var/lib/rancher/k3s:shared
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - k8s-network
    mem_limit: 2g
    shm_size: 50g
    depends_on:
      - k8s-master

  # Worker Node 2
  k8s-worker-2:
    image: rancher/k3s:latest
    container_name: k8s-worker-2
    hostname: k8s-worker-2
    restart: unless-stopped
    command: agent --kubelet-arg="feature-gates=KubeletInUserNamespace=true" --with-node-id
    tmpfs:
      - /run
      - /var/run
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    privileged: true
    environment:
      - K3S_URL=https://k8s-master:6443
      - K3S_TOKEN=k8s-cluster-secret
      - K3S_NODE_NAME=k8s-worker-2
    volumes:
      - ${ROOT_DATA_DIR}/k8s-worker-2:/var/lib/rancher/k3s:shared
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - k8s-network
    mem_limit: 2g
    shm_size: 50g
    depends_on:
      - k8s-master

  # Worker Node 3
  k8s-worker-3:
    image: rancher/k3s:latest
    container_name: k8s-worker-3
    hostname: k8s-worker-3
    restart: unless-stopped
    command: agent --kubelet-arg="feature-gates=KubeletInUserNamespace=true" --with-node-id
    tmpfs:
      - /run
      - /var/run
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    privileged: true
    environment:
      - K3S_URL=https://k8s-master:6443
      - K3S_TOKEN=k8s-cluster-secret
      - K3S_NODE_NAME=k8s-worker-3
    volumes:
      - ${ROOT_DATA_DIR}/k8s-worker-3:/var/lib/rancher/k3s:shared
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - k8s-network
    mem_limit: 2g
    shm_size: 50g
    depends_on:
      - k8s-master

  # Bastion Host (Acesso Seguro ao Cluster)
  bastion:
    image: ubuntu:22.04
    container_name: bastion
    hostname: bastion
    restart: unless-stopped
    ports:
      - "2222:22" # SSH bastion na porta 2222
    volumes:
      - ${ROOT_DATA_DIR}/k8s-config:/root/.kube:ro
      - ${ROOT_DATA_DIR}/bastion-ssh:/root/.ssh
    environment:
      - KUBECONFIG=/root/.kube/config
    networks:
      - k8s-network
    command: [
        "/bin/bash",
        "-c",
        '
        apt-get update && apt-get install -y openssh-server kubectl curl wget vim nano htop git &&
        mkdir -p /var/run/sshd /root/.ssh &&
        echo ''bastion:P@ssw0rd123!'' | chpasswd &&
        sed -i ''s/#PermitRootLogin prohibit-password/PermitRootLogin yes/'' /etc/ssh/sshd_config &&
        sed -i ''s/#PasswordAuthentication yes/PasswordAuthentication yes/'' /etc/ssh/sshd_config &&
        echo ''export KUBECONFIG=/root/.kube/config'' >> /root/.bashrc &&
        echo ''alias k=kubectl'' >> /root/.bashrc &&
        echo ''alias kg="kubectl get"'' >> /root/.bashrc &&
        echo ''alias kga="kubectl get all"'' >> /root/.bashrc &&
        echo ''echo "Bastion Host - Acesso Seguro ao Kubernetes"'' >> /root/.bashrc &&
        /usr/sbin/sshd -D
        ',
      ]
    depends_on:
      - k8s-master
    mem_limit: 512m

networks:
  k8s-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  rancher-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ROOT_DATA_DIR}/rancher-data
  k8s-master-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ROOT_DATA_DIR}/k8s-master
  k8s-worker-1-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ROOT_DATA_DIR}/k8s-worker-1
  k8s-worker-2-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ROOT_DATA_DIR}/k8s-worker-2
  k8s-worker-3-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ROOT_DATA_DIR}/k8s-worker-3
  k8s-worker-4-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${ROOT_DATA_DIR}/k8s-worker-4
